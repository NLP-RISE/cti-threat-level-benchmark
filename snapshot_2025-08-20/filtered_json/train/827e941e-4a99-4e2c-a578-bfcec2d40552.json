{
    "Event":{
        "threat_level_id":"1",
        "date":"2022-04-26",
        "published":true,
        "info":"Malware analysis report on SparrowDoor malware",
        "publish_timestamp":"1650959363",
        "timestamp":"1650959349",
        "Tag":[
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"DLL Side-Loading - T1574.002\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Deobfuscate/Decode Files or Information - T1140\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Process Hollowing - T1055.012\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Registry Run Keys / Startup Folder - T1547.001\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Token Impersonation/Theft - T1134.001\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Windows Service - T1543.003\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Clipboard Data - T1115\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Exfiltration Over C2 Channel - T1041\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"File Deletion - T1070.004\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Match Legitimate Name or Location - T1036.005\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Security Software Discovery - T1518.001\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Signed Binary Proxy Execution - T1218\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Symmetric Cryptography - T1573.001\""
            },
            {
                "name":"misp-galaxy:mitre-attack-pattern=\"Web Protocols - T1071.001\""
            },
            {
                "name":"tlp:white"
            }
        ],
        "Attribute":[
            {
                "category":"Payload delivery",
                "comment":"derived from SparrowDoor sample MD5s: 8ad3f513f48f711d573d33b7419e3ed5 / C2 domain",
                "timestamp":"1650958622",
                "type":"domain",
                "value":"cdn181.awsdns-531.com",
                "to_ids":true
            },
            {
                "category":"Persistence mechanism",
                "comment":"derived from SparrowDoor sample MD5s: 8ad3f513f48f711d573d33b7419e3ed5",
                "timestamp":"1650958224",
                "type":"regkey",
                "value":"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\services\\SearchIndexer",
                "to_ids":false
            },
            {
                "category":"Persistence mechanism",
                "comment":"derived from SparrowDoor sample MD5s: 8ad3f513f48f711d573d33b7419e3ed5",
                "timestamp":"1650958224",
                "type":"regkey",
                "value":"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\SearchIndexer",
                "to_ids":false
            },
            {
                "category":"Artifacts dropped",
                "comment":"derived from SparrowDoor sample MD5s: 8ad3f513f48f711d573d33b7419e3ed5 / Mutex created by SparrowDoor.",
                "timestamp":"1650958389",
                "type":"mutex",
                "value":"Global\\gup0",
                "to_ids":false
            },
            {
                "category":"Other",
                "comment":"",
                "timestamp":"1650958512",
                "type":"comment",
                "value":"The SparrowDoor loader performs reflective loading of a portable executable (PE) payload with no headers.",
                "to_ids":false
            },
            {
                "category":"Other",
                "comment":"",
                "timestamp":"1650958512",
                "type":"comment",
                "value":"SparrowDoor implements multiple defence evasion techniques including inline hooks and AV detection.",
                "to_ids":false
            },
            {
                "category":"Other",
                "comment":"",
                "timestamp":"1650958512",
                "type":"comment",
                "value":"SparrowDoor communicates with the command and control (C2) server over HTTPS.",
                "to_ids":false
            },
            {
                "category":"Other",
                "comment":"",
                "timestamp":"1650958512",
                "type":"comment",
                "value":"SparrowDoor supports various tasking commands, including reading/writing files and opening a reverse shell.",
                "to_ids":false
            },
            {
                "category":"Payload installation",
                "comment":"Path where malware files were recovered",
                "timestamp":"1650958704",
                "type":"filename",
                "value":"%ALLUSERSPROFILE%\\Microsoft\\DRM\\",
                "to_ids":false
            },
            {
                "category":"Other",
                "comment":"",
                "timestamp":"1650959066",
                "type":"comment",
                "value":"A legitimate and signed Notepad++ updater has been renamed SearchIndexer.exe by the malware, which is the name of a legitimate Windows file. The Notepad++ updater loads the libcurl library, SparrowDoor takes advantage of this, as the malicious loader is given the same name as the legitimate libcurl library and is side-loaded into the renamed Notepad++ updater process SearchIndexer.exe.",
                "to_ids":false
            },
            {
                "category":"Payload installation",
                "comment":"",
                "timestamp":"1650959123",
                "type":"sigma",
                "value":"title: SparrowDoor abnormal svchost.exe parent\r\ndescription: SparrowDoor spawns an instance of svchost.exe, which would be abnormal.\r\nstatus: stable\r\ndate: 2022/02/28\r\nauthor: NCSC\r\nversion: 1.0\r\npurpose: malware\r\ntlp: white\r\nlogsource:\r\n    category: process_creation\r\n     product: windows\r\ndetection:\r\n    selection1:\r\n        ParentImage|endswith: '\\SearchIndexer.exe'\r\n    selection2:\r\n        Image|endswith: '\\svchost.exe'\r\n    condition: selection1 and selection2\r\nlevel: medium\r\n\r\ntitle: SparrowDoor Clipshot\r\ndescription: SparrowDoor's loader has an export which is called by the backdoor to log clipboard data.\r\nstatus: stable\r\ndate: 2022/02/28\r\nauthor: NCSC\r\nversion: 1.0\r\npurpose: malware\r\ntlp: white\r\nlogsource:\r\n    category: process_creation\r\n     product: windows\r\ndetection:\r\n    selection1:\r\n        ParentImage|endswith: '\\svchost.exe'\r\n    selection2:\r\n        Image|endswith: '\\rundll32.exe'\r\n\tselection3:\r\n\t    CommandLine|contains: 'curl_easy_init'\r\n    condition: selection1 and selection2 and selection3\r\nlevel: medium",
                "to_ids":false
            },
            {
                "category":"External analysis",
                "comment":"",
                "timestamp":"1650959334",
                "type":"link",
                "value":"https://www.ncsc.gov.uk/report/mar-sparrowdoor",
                "to_ids":false
            }
        ],
        "Object":[
            {
                "comment":"SparrowDoor 32-bit loader",
                "description":"File object describing a file with meta-information",
                "meta-category":"file",
                "name":"file",
                "timestamp":"1650958869",
                "Attribute":[
                    {
                        "category":"Payload delivery",
                        "comment":"SparrowDoor sample / SparrowDoor 32-bit Loader",
                        "timestamp":"1650958775",
                        "type":"md5",
                        "value":"<md5>",
                        "to_ids":true
                    },
                    {
                        "category":"Payload delivery",
                        "comment":"SparrowDoor sample / SparrowDoor 32-bit Loader",
                        "timestamp":"1650958775",
                        "type":"sha1",
                        "value":"<sha1>",
                        "to_ids":true
                    },
                    {
                        "category":"Payload delivery",
                        "comment":"SparrowDoor sample / SparrowDoor 32-bit Loader",
                        "timestamp":"1650958775",
                        "type":"sha256",
                        "value":"<sha256>",
                        "to_ids":true
                    },
                    {
                        "category":"Payload delivery",
                        "comment":"derived from SparrowDoor sample MD5s: 46077a32e433a56eb8ba64dcbf86bc60 / Log file containing clipboard data, stored in the same directory as libcurl.dll.",
                        "timestamp":"1650958775",
                        "type":"filename",
                        "value":"libcurl.dll.log",
                        "to_ids":true
                    },
                    {
                        "category":"Other",
                        "comment":"",
                        "timestamp":"1650958869",
                        "type":"size-in-bytes",
                        "value":"57344",
                        "to_ids":false
                    }
                ]
            },
            {
                "comment":"Obfuscated 32-bit SparrowDoor backdoor and shellcode",
                "description":"File object describing a file with meta-information",
                "meta-category":"file",
                "name":"file",
                "timestamp":"1650958852",
                "Attribute":[
                    {
                        "category":"Payload delivery",
                        "comment":"SparrowDoor sample / Obfuscated 32-bit SparrowDoor backdoor and shellcode",
                        "timestamp":"1650958823",
                        "type":"md5",
                        "value":"<md5>",
                        "to_ids":true
                    },
                    {
                        "category":"Payload delivery",
                        "comment":"SparrowDoor sample / Obfuscated 32-bit SparrowDoor backdoor and shellcode",
                        "timestamp":"1650958823",
                        "type":"sha1",
                        "value":"<sha1>",
                        "to_ids":true
                    },
                    {
                        "category":"Payload delivery",
                        "comment":"SparrowDoor sample / Obfuscated 32-bit SparrowDoor backdoor and shellcode",
                        "timestamp":"1650958823",
                        "type":"sha256",
                        "value":"<sha256>",
                        "to_ids":true
                    },
                    {
                        "category":"Payload delivery",
                        "comment":"",
                        "timestamp":"1650958852",
                        "type":"filename",
                        "value":"libhost.dll",
                        "to_ids":true
                    },
                    {
                        "category":"Other",
                        "comment":"",
                        "timestamp":"1650958852",
                        "type":"size-in-bytes",
                        "value":"67857",
                        "to_ids":false
                    }
                ]
            },
            {
                "comment":"",
                "description":"An object describing a YARA rule (or a YARA rule name) along with its version.",
                "meta-category":"misc",
                "name":"yara",
                "timestamp":"1650959311",
                "Attribute":[
                    {
                        "category":"Other",
                        "comment":"",
                        "timestamp":"1650959311",
                        "type":"comment",
                        "value":"Identifies code segments in SparrowDoor responsible for patching APIs. No MZ/PE match as the backdoor has no header. Targeting in memory.",
                        "to_ids":false
                    },
                    {
                        "category":"Other",
                        "comment":"",
                        "timestamp":"1650959311",
                        "type":"text",
                        "value":"memory",
                        "to_ids":false
                    },
                    {
                        "category":"Payload installation",
                        "comment":"",
                        "timestamp":"1650959311",
                        "type":"yara",
                        "value":"import \"pe\"\r\n\r\nrule SparrowDoor_apipatch {\r\n    meta:\r\n        author = \"NCSC\"\r\n        description = \"Identifies code segments in SparrowDoor responsible for patching APIs. No MZ/PE match as the backdoor has no header. Targeting in memory.\"\r\n        date = \"2022-02-28\"\r\n        hash1 = \"c1890a6447c991880467b86a013dbeaa66cc615f\"\r\n\r\n    strings:\r\n\t$save = {8B 06 89 07 8A 4E 04} // save off first 5 bytes of function\r\n\t$vp_1 = {89 10 8A 4E 04 8B D6 2B D0 88 48 04 83 EA 05 C6 40 05 E9 89 50 06} // calculate long jump \r\n\t$vp_2 = {50 8B D6 6A 40 2B D7 88 4F 04 83 EA 05 6A 05 C6 47 05 E9 89 57 06 56} // calculate long jump 2\r\n\t$vp_3 = {51 52 2B DE 6A 05 83 EB 05 56 C6 06 E9 89 5E 01} // restore memory protections\r\n\t$va = {6A 40 68 00 10 00 00 68 00 10 00 00 6A 00} // virtually alloc set size, allocation and protection\r\n\t$s_patch = {50 68 7F FF FF FF 68 FF FF 00 00 56} // socket patch SO_DONTLINGER\r\n\r\n    condition:\r\n\t    3 of them\r\n}\r\n\r\nrule SparrowDoor_clipshot {\r\n    meta:\r\n        author = \"NCSC\"\r\n        description = \"The SparrowDoor loader contains a feature it calls clipshot, which logs clipboard data to a file.\"\r\n        date = \"2022-02-28\"\r\n        hash1 = \"989b3798841d06e286eb083132242749c80fdd4d\"\r\n\r\n    strings:\r\n\t    $exsting_cmp = {8B 1E 3B 19 75 ?? 83 E8 04 83 C1 04 83 C6 04 83 F8 04} // comparison routine for previous clipboard data\r\n\t    $time_format_string = \"%d/%d/%d %d:%d\" ascii\r\n\t    $cre_fil_args = {6A 00 68 80 00 00 00 6A 04 6A 00 6A 02 68 00 00 00 40 52}\t\r\n\r\n    condition:\r\n\t    (uint16(0) == 0x5A4D) and uint32(uint32(0x3C)) == 0x00004550 and all of them and (pe.imports(\"User32.dll\",\"OpenClipboard\") and pe.imports(\"User32.dll\",\"GetClipboardData\") and pe.imports(\"Kernel32.dll\",\"GetLocalTime\") and pe.imports(\"Kernel32.dll\",\"GlobalSize\"))\r\n\r\n}\r\n\r\nrule SparrowDoor_config {\r\n    meta:\r\n        author = \"NCSC\"\r\n        description = \"Targets the XOR encoded loader config and shellcode in the file libhost.dll using the known position of the XOR key.\"\r\n        date = \"2022-02-28\"\r\n        hash1 = \"c1890a6447c991880467b86a013dbeaa66cc615f\"\r\n\r\n    condition:\r\n\t    (uint16(0) != 0x5A4D) and\r\n            (uint16(0) != 0x8b55) and\r\n\t    (uint32(0) ^ uint32(0x4c) ==  0x00) and\r\n\t    (uint32(0) ^ uint32(0x34) ==  0x00) and\r\n\t    (uint16(0) ^ uint16(0x50) ==  0x8b55)\r\n}\r\n\r\nrule SparrowDoor_loader {\r\n    meta:\r\n        author = \"NCSC\"\r\n        description = \"Targets code features of the SparrowDoor loader. This rule detects the previous variant and this new variant.\"\r\n        date = \"2022-02-28\"\r\n        hash1 = \"989b3798841d06e286eb083132242749c80fdd4d\"\r\n\r\n    strings:\r\n        $xor_algo = {8B D0 83 E2 03 8A 54 14 10 30 14 30 40 3B C1}\r\n\t$rva = {8D B0 [4] 8D 44 24 ?? 50 6A 40 6A 05 56} // load RVA of process exe\r\n        $lj = {2B CE 83 E9 05 8D [3] 52 C6 06 E9 89 4E 01 8B [3] 50 6A 05 56} // calculate long jump\r\n\r\n    condition:\r\n        (uint16(0) == 0x5A4D) and uint32(uint32(0x3C)) == 0x00004550 and all of them\r\n\r\n}\r\n\r\n\r\nrule SparrowDoor_shellcode {\r\n    meta:\r\n        author = \"NCSC\"\r\n        description = \"Targets code features of the reflective loader for SparrowDoor. Targeting in memory.\"\r\n        date = \"2022-02-28\"\r\n        hash1 = \"c1890a6447c991880467b86a013dbeaa66cc615f\"\r\n\r\n    strings:\r\n        $peb = {8B 48 08 89 4D FC 8B 51 3C 8B 54 0A 78 8B 74 0A 20 03 D1 03 F1 B3 64}\r\n\t$getp_match = {8B 06 03 C1 80 38 47 75 34 80 78 01 65 75 2E 80 78 02 74 75 28 80 78 03 50 75 22 80 78 04 72 75 1C 80 78 06 63 75 16 80 78 05 6F 75 10 80 78 07 41 75 0A}\r\n        $k_check = {8B 48 20 8A 09 80 F9 6B 74 05 80 F9 4B 75 05}\r\n        $resolve_load_lib = {C7 45 C4 4C 6F 61 64 C7 45 C8 4C 69 62 72 C7 45 CC 61 72 79 41 C7 45 D0 00 00 00 00 FF 75 FC FF 55 E4}\t\t\r\n\r\n    condition:\r\n        3 of them\r\n}\r\n\r\n\r\nrule SparrowDoor_sleep_routine {\r\n    meta:\r\n        author = \"NCSC\"\r\n        description = \"SparrowDoor implements a Sleep routine with value seeded on GetTickCount. This signature detects the previous and this variant of SparrowDoor. No MZ/PE match as the backdoor has no header. Targeting in memory.\"\r\n        date = \"2022-02-28\"\r\n        hash1 = \"c1890a6447c991880467b86a013dbeaa66cc615f\"\r\n\r\n    strings:\r\n        $sleep = {FF D7 33 D2 B9 [4] F7 F1 81 C2 [4] 8B C2 C1 E0 04 2B C2 03 C0 03 C0 03 C0 50}\r\n\r\n    condition:\r\n\t  all of them\r\n}\r\n\r\nrule SparrowDoor_xor {\r\n    meta:\r\n        author = \"NCSC\"\r\n        description = \"Highlights XOR routines in SparrowDoor. No MZ/PE match as the backdoor has no header. Targeting in memory.\"\r\n        date = \"2022-02-28\"\r\n        hash1 = \"c1890a6447c991880467b86a013dbeaa66cc615f\"\r\n\r\n    strings:\r\n        $xor_routine_outbound = {B8 39 8E E3 38 F7 E1 D1 EA 8D 14 D2 8B C1 2B C2 8A [4] 00 30 14 39 41 3B CE}\r\n\t$xor_routine_inbound = {B8 25 49 92 24 F7 E1 8B C1 2B C2 D1 E8 03 C2 C1 E8 02 8D 14 C5 [4] 2B D0 8B C1 2B C2}\r\n        $xor_routine_config = {8B D9 83 E3 07 0F [6] 30 18 8D 1C 07 83 E3 07 0F [6] 30 58 01 8D 1C 28 83 E3 07 0F [6] 30 58 02 8D 1C 02 83 E3 07 0F [6] 30 58 03 8B DE 83 E3 07 0F [6] 30 58 04 83 C6 05 83 C1 05}\r\n\r\n    condition:\r\n\t    2 of them\r\n}\r\n\r\nrule SparrowDoor_strings {\r\n    meta:\r\n        author = \"NCSC\"\r\n        description = \"Strings that appear in SparrowDoor's backdoor. Targeting in memory.\"\r\n        date = \"2022-02-28\"\r\n        hash1 = \"c1890a6447c991880467b86a013dbeaa66cc615f\"\r\n\r\n    strings:\r\n        $reg = \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\" ascii\r\n\t$http_headers = {55 73 65 72 2D 41 67 65 6E 74 3A 20 4D 6F 7A 69 6C 6C 61 2F 34 2E 30 20 28 63 6F 6D 70 61 74 69 62 6C 65 3B 20 4D 53 49 45 20 35 2E 30 3B 20 57 69 6E 64 6F 77 73 20 4E 54 20 35 2E 30 29 0D 0A 41 63 63 65 70 74 2D 4C 61 6E 67 75 61 67 65 3A 20 65 6E 2D 55 53 0D 0A 41 63 63 65 70 74 3A 20 2A 2F 2A 0D 0A}\r\n\t$http_proxy = \"HTTPS=HTTPS://%s:%d\" ascii\r\n\t$debug = \"SeDebugPrivilege\" ascii\r\n\t$av1 = \"avp.exe\" ascii // Kaspersky\r\n\t$av2 = \"ZhuDongFangYu.exe\" ascii // Qihoo360\r\n\t$av3 = \"egui.exe\" ascii // ESET\r\n\t$av4 = \"TMBMSRV.exe\" ascii // Trend Micro\r\n\t$av5 = \"ccSetMgr.exe\" ascii // Norton\r\n\t$clipshot = \"clipshot\" ascii\r\n\t$ComSpec =  \"ComSpec\" ascii\r\n\t$export = \"curl_easy_init\" ascii\r\n\r\n    condition:\r\n        10 of them\r\n}",
                        "to_ids":true
                    },
                    {
                        "category":"Other",
                        "comment":"",
                        "timestamp":"1650959311",
                        "type":"text",
                        "value":"SparrowDoor_apipatch",
                        "to_ids":false
                    }
                ]
            }
        ]
    }
}