# Threat Report: 2016-11-17: It’s Parliamentary: KeyBoy and the targeting of the Tibetan Community


## Key Intelligence
* Date: 2016-11-17
* Threat Level: 2 (Medium)
* Tags: circl:incident-classification="phishing", tlp:white, osint:source-type="blog-post", misp-galaxy:tool="KeyBoy"

---

## Indicators of Compromise (IOCs)
### Artifacts dropped
* md5: <md5> — Wab32res.exe legitimate file used for DLL side loading
* md5: <md5> — Wab32res.dll payload, KeyBoy 20160509
* md5: <md5> — Payload KeyBoy P_20150313
* md5: <md5> — Payload KeyBoy 20151108
* md5: <md5> — Payload KeyBoy 20151108
* md5: <md5> — 64b KeyBoy payload 20151108
* md5: <md5> — wab32res.dll, agewkassif version
* regkey: HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Ver — Contains the Keyboy version
* sha256: <sha256> — legitimate Microsoft Windows Address Book executable, used to load final payload
* sha256: <sha256> — Wab32res.dll payload, KeyBoy 20160509
* sha256: <sha256> — Wab32res.dll payload, KeyBoy agewkassif version
* yara: import "pe"
rule new_keyboy_export
{
meta:
author = "Matt Brooks, @cmatthewbrooks"
desc = "Matches the new 2016 sample's export"
date = "2016-08-28"
md5 = "495adb1b9777002ecfe22aaf52fcee93"

condition:
//MZ header
uint16(0) == 0x5A4D and

//PE signature
uint32(uint32(0x3C)) == 0x00004550 and


filesize < 200KB and


//The malware family seems to share many exports
//but this is the new kid on the block.
pe.exports("cfsUpdate")
}
* yara: rule new_keyboy_header_codes
{
meta:
author = "Matt Brooks, @cmatthewbrooks"
desc = "Matches the 2016 sample's header codes"
date = "2016-08-28"
md5 = "495adb1b9777002ecfe22aaf52fcee93"

strings:
$s1 = "*l*" wide fullword
$s2 = "*a*" wide fullword
$s3 = "*s*" wide fullword
$s4 = "*d*" wide fullword
$s5 = "*f*" wide fullword
$s6 = "*g*" wide fullword
$s7 = "*h*" wide fullword

condition:
//MZ header
uint16(0) == 0x5A4D and

//PE signature
uint32(uint32(0x3C)) == 0x00004550 and
filesize < 200KB and
all of them
}
* yara: rule keyboy_commands
{
meta:
author = "Matt Brooks, @cmatthewbrooks"
desc = "Matches the 2016 sample's sent and received commands"
date = "2016-08-28"
md5 = "495adb1b9777002ecfe22aaf52fcee93"

strings:
$s1 = "Update" wide fullword
$s2 = "UpdateAndRun" wide fullword
$s3 = "Refresh" wide fullword
$s4 = "OnLine" wide fullword
$s5 = "Disconnect" wide fullword
$s6 = "Pw_Error" wide fullword
$s7 = "Pw_OK" wide fullword
$s8 = "Sysinfo" wide fullword
$s9 = "Download" wide fullword
$s10 = "UploadFileOk" wide fullword
$s11 = "RemoteRun" wide fullword
$s12 = "FileManager" wide fullword

condition:
//MZ header
uint16(0) == 0x5A4D and

//PE signature
uint32(uint32(0x3C)) == 0x00004550 and
filesize < 200KB and
6 of them
}
* yara: rule keyboy_errors
{
meta:
author = "Matt Brooks, @cmatthewbrooks"
desc = "Matches the sample's shell error2 log statements"
date = "2016-08-28"
md5 = "495adb1b9777002ecfe22aaf52fcee93"

strings:
//These strings are in ASCII pre-2015 and UNICODE in 2016
$error = "Error2" ascii wide
//2016 specific:
$s1 = "Can't find [%s]!Check the file name and try again!" ascii wide
$s2 = "Open [%s] error! %d" ascii wide
$s3 = "The Size of [%s] is zero!" ascii wide
$s4 = "CreateThread DownloadFile[%s] Error!" ascii wide
$s5 = "UploadFile [%s] Error:Connect Server Failed!" ascii wide
$s6 = "Receive [%s] Error(Recved[%d] != Send[%d])!" ascii wide
$s7 = "Receive [%s] ok! Use %2.2f seconds, Average speed %2.2f k/s" ascii wide
$s8 = "CreateThread UploadFile[%s] Error!" ascii wide
//Pre-2016:
$s9 = "Ready Download [%s] ok!" ascii wide
$s10 = "Get ControlInfo from FileClient error!" ascii wide
$s11 = "FileClient has a error!" ascii wide
$s12 = "VirtualAlloc SendBuff Error(%d)" ascii wide
$s13 = "ReadFile [%s] Error(%d)..." ascii wide
$s14 = "ReadFile [%s] Data[Readed(%d) != FileSize(%d)] Error..." ascii wide
$s15 = "CreateThread DownloadFile[%s] Error!" ascii wide
$s16 = "RecvData MyRecv_Info Size Error!" ascii wide
$s17 = "RecvData MyRecv_Info Tag Error!" ascii wide
$s18 = "SendData szControlInfo_1 Error!" ascii wide
$s19 = "SendData szControlInfo_3 Error!" ascii wide
$s20 = "VirtualAlloc RecvBuff Error(%d)" ascii wide
$s21 = "RecvData Error!" ascii wide
$s22 = "WriteFile [%s} Error(%d)..." ascii wide

condition:
//MZ header
uint16(0) == 0x5A4D and

//PE signature
uint32(uint32(0x3C)) == 0x00004550 and
filesize < 200KB and
$error and 3 of ($s*)
}
* yara: rule keyboy_systeminfo
{
meta:
author = "Matt Brooks, @cmatthewbrooks"
desc = "Matches the system information format before sending to C2"
date = "2016-08-28"
md5 = "495adb1b9777002ecfe22aaf52fcee93"

strings:
//These strings are ASCII pre-2015 and UNICODE in 2016
$s1 = "SystemVersion: %s" ascii wide
$s2 = "Product ID: %s" ascii wide
$s3 = "InstallPath: %s" ascii wide
$s4 = "InstallTime: %d-%d-%d, %02d:%02d:%02d" ascii wide
$s5 = "ResgisterGroup: %s" ascii wide
$s6 = "RegisterUser: %s" ascii wide
$s7 = "ComputerName: %s" ascii wide
$s8 = "WindowsDirectory: %s" ascii wide
$s9 = "System Directory: %s" ascii wide
$s10 = "Number of Processors: %d" ascii wide
$s11 = "CPU[%d]: %s: %sMHz" ascii wide
$s12 = "RAM: %dMB Total, %dMB Free." ascii wide
$s13 = "DisplayMode: %d x %d, %dHz, %dbit" ascii wide
$s14 = "Uptime: %d Days %02u:%02u:%02u" ascii wide

condition:
//MZ header
uint16(0) == 0x5A4D and

//PE signature
uint32(uint32(0x3C)) == 0x00004550 and
filesize < 200KB and
7 of them
}
* yara: import "pe"
rule keyboy_related_exports
{
meta:
author = "Matt Brooks, @cmatthewbrooks"
desc = "Matches the new 2016 sample's export"
date = "2016-08-28"
md5 = "495adb1b9777002ecfe22aaf52fcee93"

condition:
//MZ header
uint16(0) == 0x5A4D and

//PE signature
uint32(uint32(0x3C)) == 0x00004550 and


filesize < 200KB and


//The malware family seems to share many exports
//but this is the new kid on the block.
pe.exports("Embedding") or
pe.exports("SSSS") or
pe.exports("GetUP")
}
* yara: import "pe"
rule keyboy_init_config_section
{
meta:
author = "Matt Brooks, @cmatthewbrooks"
desc = "Matches the Init section where the config is stored"
date = "2016-08-28"

condition:
//MZ header
uint16(0) == 0x5A4D and

//PE signature
uint32(uint32(0x3C)) == 0x00004550 and

//Payloads are normally smaller but the new dropper we spotted
//is a bit larger.
filesize < 300KB and

//Observed virtual sizes of the .Init section vary but they've
//always been 1024, 2048, or 4096 bytes.
for any i in (0..pe.number_of_sections - 1):
(
pe.sections[i].name == ".Init" and
pe.sections[i].virtual_size % 1024 == 0
)
}
* sha1: <sha1> — Wab32res.dll payload, KeyBoy agewkassif version - Xchecked via VT: 5da2f14c382d7cac8dfa6c86e528a646a81f0b40cfee9611c8cfb4b5d589aa88
* sha1: <sha1> — Wab32res.dll payload, KeyBoy 20160509 - Xchecked via VT: 9a55577d357922711ab0821bf5379289293c8517ae1d94d48c389f306af57a04
* sha1: <sha1> — legitimate Microsoft Windows Address Book executable, used to load final payload - Xchecked via VT: 58105e9772f6befbc319c147a97faded4fbacf839947b34fe3695ae72771da5d
* sha256: <sha256> — 64b KeyBoy payload 20151108 - Xchecked via VT: 371bc132499f455f06fa80696db0df27
* sha1: <sha1> — 64b KeyBoy payload 20151108 - Xchecked via VT: 371bc132499f455f06fa80696db0df27
* sha256: <sha256> — Payload KeyBoy 20151108 - Xchecked via VT: c5b5f01ba24d6c02636388809f44472e
* sha1: <sha1> — Payload KeyBoy 20151108 - Xchecked via VT: c5b5f01ba24d6c02636388809f44472e
* sha256: <sha256> — Payload KeyBoy 20151108 - Xchecked via VT: 98977426d544bd145979f65f0322ae30
* sha1: <sha1> — Payload KeyBoy 20151108 - Xchecked via VT: 98977426d544bd145979f65f0322ae30
* sha256: <sha256> — Payload KeyBoy P_20150313 - Xchecked via VT: 0c7e55509e0b6d4277b3facf864af018
* sha1: <sha1> — Payload KeyBoy P_20150313 - Xchecked via VT: 0c7e55509e0b6d4277b3facf864af018

### External analysis
* link: https://citizenlab.org/2016/11/parliament-keyboy/
* link: https://www.virustotal.com/file/542c85fda8df8510c1b66a122e459aac8c0919f1fe9fa2c43fd87899cffa05bf/analysis/1479643747/ — dropper of 'agewkassif' sample - Xchecked via VT: 542c85fda8df8510c1b66a122e459aac8c0919f1fe9fa2c43fd87899cffa05bf
* link: https://www.virustotal.com/file/5f24a5ee9ecfd4a8e5f967ffcf24580a83942cd7b09d310b9525962ed2614a49/analysis/1479643732/ — dw20.exe dropper - Xchecked via VT: 5f24a5ee9ecfd4a8e5f967ffcf24580a83942cd7b09d310b9525962ed2614a49
* link: https://www.virustotal.com/file/5da2f14c382d7cac8dfa6c86e528a646a81f0b40cfee9611c8cfb4b5d589aa88/analysis/1479643740/ — Wab32res.dll payload, KeyBoy agewkassif version - Xchecked via VT: 5da2f14c382d7cac8dfa6c86e528a646a81f0b40cfee9611c8cfb4b5d589aa88
* link: https://www.virustotal.com/file/9a55577d357922711ab0821bf5379289293c8517ae1d94d48c389f306af57a04/analysis/1479499742/ — Wab32res.dll payload, KeyBoy 20160509 - Xchecked via VT: 9a55577d357922711ab0821bf5379289293c8517ae1d94d48c389f306af57a04
* link: https://www.virustotal.com/file/58105e9772f6befbc319c147a97faded4fbacf839947b34fe3695ae72771da5d/analysis/1478876071/ — legitimate Microsoft Windows Address Book executable, used to load final payload - Xchecked via VT: 58105e9772f6befbc319c147a97faded4fbacf839947b34fe3695ae72771da5d
* link: https://www.virustotal.com/file/ba442907f3218c8664bbecb47f915c4469340219e0f05af8f2d108d72659ff0f/analysis/1479483627/ — Doc exploiting CVE-2012-0158 - Xchecked via VT: 8846d109b457a2ee44ddbf54d1cf7944
* link: https://www.virustotal.com/file/442e5d3d46330e814b4fdc5640b06732de69a08a574d92cd9a0df5eea62d88ed/analysis/1479484054/ — Malicious doc with CVE-2014-4114 vulnerability - Xchecked via VT: 05b5cf94f07fee666eb086c91182ad25
* link: https://www.virustotal.com/file/b1d1b8fa9c104309fe27b3405d3572ac44d8401efba4868f743d45ed797d444b/analysis/1479485679/ — Other similar doc - Xchecked via VT: beadf21b923600554b0ce54df42e78f5
* link: https://www.virustotal.com/file/4c9bf4ffbd7047f46035f89e6f7f4c63b8597ac63097577d467c157e3aa7ab4d/analysis/1479643752/ — 64b KeyBoy payload 20151108 - Xchecked via VT: 371bc132499f455f06fa80696db0df27
* link: https://www.virustotal.com/file/e6fdcf64d7e7d59366ba23c68332167dfc569b6acc71a03498d4a925ce9c1e0a/analysis/1479481835/ — Payload KeyBoy 20151108 - Xchecked via VT: c5b5f01ba24d6c02636388809f44472e
* link: https://www.virustotal.com/file/082da7874d6c0bfbe8f2d954c8a47f25a90ef83bda89c8495101dc95986d7977/analysis/1479643737/ — Payload KeyBoy 20151108 - Xchecked via VT: 98977426d544bd145979f65f0322ae30
* link: https://www.virustotal.com/file/5395f709ef1ca64c57be367f9795b66b5775b6e73f57089386a85925cc0ec596/analysis/1431473021/ — Payload KeyBoy P_20150313 - Xchecked via VT: 0c7e55509e0b6d4277b3facf864af018

### Network activity
* domain: tibetvoices.com — domain linked to one of the C2 IPs
* domain: www.about.jkub.com — C2 domains
* domain: www.eleven.mypop3.org — C2 domains
* domain: www.backus.myftp.name — C2 domains
* ip-dst: 45.125.12.147 — C2 IP
* ip-dst: 103.40.102.233 — C2 IP
* ip-dst: 116.193.154.69 — C2 IP
* ip-dst: 103.242.134.243 — C2 IP
* ip-dst: 45.32.47.148 — IPs for C2 Host: www.about.jkub.com
* ip-dst: 157.7.84.81 — IPs for C2 Host: www.about.jkub.com
* ip-dst: 192.241.149.43 — IP behind C2 Host: www.backus.myftp[.]name
* ip-dst: 112.10.117.47 — Other IP hosting tibetvoices.com

### Payload delivery
* email-src: tibetanparliarnent@yahoo.com — Source of phishing emails
* md5: <md5> — theme of the conference.doc
* md5: <md5> — Dw20.exe dropper
* md5: <md5> — Other similar doc
* md5: <md5> — Dw20.exe dropper
* md5: <md5> — Malicious doc with CVE-2014-4114 vulnerability
* md5: <md5> — Doc exploiting CVE-2012-0158
* md5: <md5> — Attached file urgent action larung gar buddhist academy.rtf (CVE-2015-1641)
* md5: <md5> — dropper of 'agewkassif' version
* sha256: <sha256> — dw20.exe dropper
* sha256: <sha256> — dropper of 'agewkassif' sample
* vulnerability: CVE-2012-0158
* vulnerability: CVE-2014-4114
* vulnerability: CVE-2015-1641
* yara: rule CVE_2012_0158_KeyBoy {
meta:
author = "Etienne Maynier <etienne@citizenlab.ca>"
description = "CVE-2012-0158 variant"
file = "8307e444cad98b1b59568ad2eba5f201"

strings:
$a = "d0cf11e0a1b11ae1000000000000000000000000000000003e000300feff09000600000000000000000000000100000001" nocase // OLE header
$b = "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff" nocase // junk data
$c = /5(\{\\b0\}|)[ ]*2006F00(\{\\b0\}|)[ ]*6F007(\{\\b0\}|)[ ]*400200045(\{\\b0\}|)[ ]*006(\{\\b0\}|)[ ]*E007(\{\\b0\}|)[ ]*400720079/ nocase
$d = "MSComctlLib.ListViewCtrl.2"
$e = "ac38c874503c307405347aaaebf2ac2c31ebf6e8e3" nocase //decoding shellcode

condition:
all of them
}
* yara: rule keyboy_exploit_doc_meta{
meta:
author = "Matt Brooks, @cmatthewbrooks"
desc = "Matches the meta associated with these exploit docs"
date = "2016-09-30"

strings:
$role = "{\\author Master}{\\operator Master}"
$creatim = "{\\creatim\\yr2015\\mo10\\dy16\\hr11\\min37}"
$revtim = "{\\revtim\\yr2015\\mo10\\dy16\\hr13\\min54}"

condition:
uint32be(0) == 0x7B5C7274 and
filesize < 1MB and
all of them
}
* sha1: <sha1> — dropper of 'agewkassif' sample - Xchecked via VT: 542c85fda8df8510c1b66a122e459aac8c0919f1fe9fa2c43fd87899cffa05bf
* sha1: <sha1> — dw20.exe dropper - Xchecked via VT: 5f24a5ee9ecfd4a8e5f967ffcf24580a83942cd7b09d310b9525962ed2614a49
* sha256: <sha256> — Doc exploiting CVE-2012-0158 - Xchecked via VT: 8846d109b457a2ee44ddbf54d1cf7944
* sha1: <sha1> — Doc exploiting CVE-2012-0158 - Xchecked via VT: 8846d109b457a2ee44ddbf54d1cf7944
* sha256: <sha256> — Malicious doc with CVE-2014-4114 vulnerability - Xchecked via VT: 05b5cf94f07fee666eb086c91182ad25
* sha1: <sha1> — Malicious doc with CVE-2014-4114 vulnerability - Xchecked via VT: 05b5cf94f07fee666eb086c91182ad25
* sha256: <sha256> — Other similar doc - Xchecked via VT: beadf21b923600554b0ce54df42e78f5
* sha1: <sha1> — Other similar doc - Xchecked via VT: beadf21b923600554b0ce54df42e78f5

### Payload type
* text: KeyBoy
