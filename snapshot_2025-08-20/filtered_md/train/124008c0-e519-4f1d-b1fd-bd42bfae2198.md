# Threat Report: 2023-12-06: MAR-10478915-1.v1 Citrix Bleed


## Key Intelligence
* Date: 2023-12-06
* Threat Level: 3 (Low)
* Tags: type:OSINT, osint:lifetime="perpetual", tlp:white, tlp:clear, misp-galaxy:mitre-attack-pattern="Exploit Public-Facing Application - T1190"

---

## Indicators of Compromise (IOCs)
### Payload installation
* yara: 'namespace'='CISA_Consolidated.yara' rule_name=CISA_10478915_01 rule_content=rule CISA_10478915_01 : trojan installs_other_components
{
	meta:
		author = "CISA Code & Media Analysis"
		incident = "10478915"
		date = "2023-11-06"
		last_modified = "20231108_1500"
		actor = "n/a"
		family = "n/a"
		capabilities = "installs-other-components"
		malware_Type = "trojan"
		tool_type = "information-gathering"
		description = "Detects trojan .bat samples"
		sha256 = "98e79f95cf8de8ace88bf223421db5dce303b112152d66ffdf27ebdfcdf967e9"
	strings:
		$s1 = { 63 3a 5c 77 69 6e 64 6f 77 73 5c 74 61 73 6b 73 5c 7a 2e 74 78 74 }
		$s2 = { 72 65 67 20 73 61 76 65 20 68 6b 6c 6d 5c 73 79 73 74 65 6d 20 63 3a 5c 77 69 6e 64 6f 77 73 5c 74 61 73 6b 73 5c 65 6d }
		$s3 = { 6d 61 6b 65 63 61 62 20 63 3a 5c 75 73 65 72 73 5c 70 75 62 6c 69 63 5c 61 2e 70 6e 67 20 63 3a 5c 77 69 6e 64 6f 77 73 5c 74 61 73 6b 73 5c 61 2e 63 61 62 }
	condition:
		all of them
} — This file is a Windows batch file called a.bat that is used to execute the file called a.exe with the file called a.dll as an argument.  The output is printed to a file named 'z.txt' located in the path C:\Windows\Tasks.  Next, a.bat pings the loop back internet protocol (IP) address 127.0.0[.]1 three times. 

The next command it runs is reg save to save the HKLM\SYSTEM registry hive into the C:\Windows\tasks\em directory.  Again, a.bat pings the loop back address 127.0.0[.]1 one time before executing another reg save command and saves the HKLM\SAM registry hive into the C:\Windows\Task\am directory.  Next, a.bat runs three makecab commands to create three Cabinet (.cab) files from the previously mentioned saved registry hives and one file named C:\Users\Public\a.png.  The names of the .cab files are as follows:

--Start names and paths of .cab files created--
c:\windows\tasks\em.cab
c:\windows\tasks\am.cab
c:\windows\tasks\a.cab
--End names and paths of .cab files created--
* yara: 'namespace'='CISA_Consolidated.yara' rule_name=CISA_10478915_02 rule_content=rule CISA_10478915_02 : trojan installs_other_components
{
	meta:
		author = "CISA Code & Media Analysis"
		incident = "10478915"
		date = "2023-11-06"
		last_modified = "20231108_1500"
		actor = "n/a"
		family = "n/a"
		capabilities = "installs-other-components"
		malware_type = "trojan"
		tool_type = "unknown"
		description = "Detects trojan PE32 samples"
		sha256 = "e557e1440e394537cca71ed3d61372106c3c70eb6ef9f07521768f23a0974068"
	strings:
		$s1 = { 57 72 69 74 65 46 69 6c 65 }
		$s2 = { 41 70 70 50 6f 6c 69 63 79 47 65 74 50 72 6f 63 65 73 73 54 65 72 6d 69 6e 61 74 69 6f 6e 4d 65 74 68 6f 64 }
		$s3 = { 6f 70 65 72 61 74 6f 72 20 63 6f 5f 61 77 61 69 74 }
		$s4 = { 43 6f 6d 70 6c 65 74 65 20 4f 62 6a 65 63 74 20 4c 6f 63 61 74 6f 72 }
		$s5 = { 64 65 6c 65 74 65 5b 5d }
		$s6 = { 4e 41 4e 28 49 4e 44 29 }
	condition:
		uint16(0) == 0x5a4d and pe.imphash() == "6e8ca501c45a9b85fff2378cffaa24b2" and pe.size_of_code == 84480 and all of them
} — This file is a 64-bit Windows command-line executable called a.exe that is executed by a.bat.  This file issues the Remote Procedure Call (RPC) ncalrpc:[lsasspirpc] to the RPC end point to provide a file path to the LSASS on the infected machine.  Once the file path is returned, the malware loads the accompanying DLL file called a.dll into the running LSASS process.  If the DLL is correctly loaded, then the malware outputs the message "[*]success" in the console.
* yara: 'namespace'='CISA_Consolidated.yara' rule_name=CISA_10478915_03 rule_content=rule CISA_10478915_03 : trojan steals_authentication_credentials credential_exploitation
{
	meta:
		author = "CISA Code & Media Analysis"
		incident = "10478915"
		date = "2023-11-06"
		last_modified = "20231108_1500"
		actor = "n/a"
		family = "n/a"
		capabilities = "steals-authentication-credentials"
		malware_type = "trojan"
		tool_type = "credential-exploitation"
		description = "Detects trojan DLL samples"
		sha256 = "17a27b1759f10d1f6f1f51a11c0efea550e2075c2c394259af4d3f855bbcc994"
	strings:
		$s1 = { 64 65 6c 65 74 65 }
		$s2 = { 3c 2f 74 72 75 73 74 49 6e 66 6f 3e }
		$s3 = { 42 61 73 65 20 43 6c 61 73 73 20 44 65 73 63 72 69 70 74 6f 72 20 61 74 20 28 }
		$s4 = { 49 6e 69 74 69 61 6c 69 7a 65 43 72 69 74 69 63 61 6c 53 65 63 74 69 6f 6e 45 78 }
		$s5 = { 46 69 6e 64 46 69 72 73 74 46 69 6c 65 45 78 57 }
		$s6 = { 47 65 74 54 69 63 6b 43 6f 75 6e 74 }
	condition:
		uint16(0) == 0x5a4d and pe.subsystem == pe.SUBSYSTEM_WINDOWS_CUI and pe.size_of_code == 56832 and all of them
} — This file is a 64-bit Windows DLL called a.dll that is executed by a.bat as a parameter for the file a.exe.  The file a.exe loads this file into the running LSASS process on the infected machine.  The file a.dll calls the Windows API CreateFileW to create a file called a.png in the path C:\Users\Public.

Next, a.dll loads DbgCore.dll then utilizes MiniDumpWriteDump function to dump LSASS process memory to disk.  If successful, the dumped process memory is written to a.png.  Once this is complete, the file a.bat specifies that the file a.png is used to create the cabinet file called a.cab in the path C:\Windows\Tasks.
* yara: 'namespace'='CISA_Consolidated.yara' rule_name=CISA_10478915_04 rule_content=rule CISA_10478915_04 : backdoor communicates_with_c2 remote_access
{
	meta:
		author = "CISA Code & Media Analysis"
		incident = "10478915"
		date = "2023-11-06"
		last_modified = "20231108_1500"
		actor = "n/a"
		family = "n/a"
		capabilities = "communicates-with-c2"
		malware_type = "backdoor"
		tool_type = "remote-access"
		description = "Detects trojan python samples"
		sha256 = "906602ea3c887af67bcb4531bbbb459d7c24a2efcb866bcb1e3b028a51f12ae6"
	strings:
		$s1 = { 70 6f 72 74 20 3d 20 34 34 33 20 69 66 20 22 68 74 74 70 73 22 } 
		$s2 = { 6b 77 61 72 67 73 2e 67 65 74 28 22 68 61 73 68 70 61 73 73 77 64 22 29 3a }
		$s3 = { 77 69 6e 72 6d 2e 53 65 73 73 69 6f 6e 20 62 61 73 69 63 20 65 72 72 6f 72 }
		$s4 = { 57 69 6e 64 77 6f 73 63 6d 64 2e 72 75 6e 5f 63 6d 64 28 73 74 72 28 63 6d 64 29 29 }
	condition:
		all of them
} — This file is a Python script called a.py that attempts to leverage WinRM to establish a session.  The script attempts to authenticate to the remote machine using NT LAN Manager (NTLM) if the keyword "hashpasswd" is present.  If the keyword "hashpasswd" is not present, then the script attempts to authenticate using basic authentication.  Once a WinRM session is established with the remote machine, the script has the ability to execute command line arguments on the remote machine.  If there is no command specified, then a default command of “whoami” is run.

## Objects
### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: antiy
* [Other] text: unknown
* [Other] text: Trojan/Win64.Malgent

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5>
* [Payload delivery] sha1: <sha1>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] sha512: <sha512>
* [Payload delivery] ssdeep: <ssdeep>
* [Payload delivery] filename: a.exe
* [Other] size-in-bytes: 145920

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: avira
* [Other] text: unknown
* [Other] text: TR/Redcap.sbphc

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: bitdefender
* [Other] text: unknown
* [Other] text: Trojan.GenericKD.70103917

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: emsisoft
* [Other] text: unknown
* [Other] text: Trojan.GenericKD.70103917 (B)

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: ikarus
* [Other] text: unknown
* [Other] text: Trojan.Win64.Malgent

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: k7
* [Other] text: unknown
* [Other] text: Riskware ( 00584baa1 )

### malware — Malware is a type of TTP that represents malicious code.
* [Other] text: This file is a 64-bit Windows command-line executable called a.exe that is executed by a.bat.  This file issues the Remote Procedure Call (RPC) ncalrpc:[lsasspirpc] to the RPC end point to provide a file path to the LSASS on the infected machine.  Once the file path is returned, the malware loads the accompanying DLL file called a.dll into the running LSASS process.  If the DLL is correctly loaded, then the malware outputs the message "[*]success" in the console.
* [Other] boolean: 0
* [Other] text: trojan

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5>
* [Payload delivery] sha1: <sha1>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] sha512: <sha512>

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: antiy
* [Other] text: unknown
* [Other] text: Trojan/Win64.Agent

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5>
* [Payload delivery] sha1: <sha1>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] sha512: <sha512>
* [Payload delivery] ssdeep: <ssdeep>
* [Payload delivery] filename: a.dll
* [Other] size-in-bytes: 106496

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: bitdefender
* [Other] text: unknown
* [Other] text: Trojan.GenericKD.70057986

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: eset
* [Other] text: unknown
* [Other] text: a variant of Win64/Agent.DAU trojan

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: emsisoft
* [Other] text: unknown
* [Other] text: Trojan.GenericKD.70057986 (B)

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: ikarus
* [Other] text: unknown
* [Other] text: Trojan.Win64.Agent

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: k7
* [Other] text: unknown
* [Other] text: Trojan ( 005ad67a1 )

### malware-analysis — Malware Analysis captures the metadata and results of a particular static or dynamic analysis performed on a malware instance or family.
* [Other] text: zillya
* [Other] text: unknown
* [Other] text: Trojan.Agent.Win64.39686

### malware — Malware is a type of TTP that represents malicious code.
* [Other] text: This file is a 64-bit Windows DLL called a.dll that is executed by a.bat as a parameter for the file a.exe.  The file a.exe loads this file into the running LSASS process on the infected machine.  The file a.dll calls the Windows API CreateFileW to create a file called a.png in the path %PUBLIC%\

Next, a.dll loads DbgCore.dll then utilizes MiniDumpWriteDump function to dump LSASS process memory to disk.  If successful, the dumped process memory is written to a.png.  Once this is complete, the file a.bat specifies that the file a.png is used to create the cabinet file called a.cab in the path %WINDIR%\Tasks.
* [Other] boolean: 0
* [Other] text: trojan

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5>
* [Payload delivery] sha1: <sha1>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] sha512: <sha512>

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5>
* [Payload delivery] sha1: <sha1>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] sha512: <sha512>
* [Payload delivery] ssdeep: <ssdeep>
* [Payload delivery] filename: a.bat
* [Other] size-in-bytes: 376

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5>
* [Payload delivery] sha1: <sha1>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] sha512: <sha512>
* [Payload delivery] ssdeep: <ssdeep>
* [Payload delivery] filename: a.py
* [Other] size-in-bytes: 2645

### original-imported-file — Object describing the original file used to import data in MISP.
* [External analysis] attachment: MAR-10478915.r1.v1.CLEAR_stix2.json
* [Other] text: STIX 2.1

### report — Metadata used to generate an executive level report
* [External analysis] link: https://www.cisa.gov/news-events/analysis-reports/ar23-325a
* [Other] text: Responding to the recently disclosed CVE-2023-4966, affecting Citrix NetScaler ADC and NetScaler Gateway appliances, CISA received four files for analysis that show files being used to save registry hives, dump the Local Security Authority Subsystem Service (LSASS) process memory to disk, and attempts to establish sessions via Windows Remote Management (WinRM). The files include:

    Windows Batch file (.bat)
    Windows Executable (.exe)
    Windows Dynamic Link Library (.dll)
    Python Script (.py)

For more information about this vulnerability, see Joint Cybersecurity Advisory #StopRansomware: LockBit 3.0 Ransomware Affiliates Exploit CVE 2023-4966 Citrix Bleed Vulnerability.
* [External analysis] attachment: MAR-10478915.r1.v1.CLEAR_.pdf
* [Other] text: AR23-325A
