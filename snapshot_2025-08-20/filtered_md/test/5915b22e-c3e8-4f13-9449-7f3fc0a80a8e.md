# Threat Report: 2017-05-12: Ransomware spreading through SMB attacking multiple companies


## Key Intelligence
* Date: 2017-05-12
* Threat Level: 3 (Low)
* Tags: malware_classification:malware-category="Ransomware", circl:incident-classification="vulnerability", tlp:white, misp-galaxy:ransomware="WannaCry", Trj=Doublepulsar, misp-galaxy:tool="ETERNALBLUE", Symantec

---

## Indicators of Compromise (IOCs)
### Artifacts dropped
* mutex: MsWinZonesCacheCounterMutexA — https://twitter.com/gN3mes1s/status/863149075159543808
* yara: /*
    This Yara ruleset is under the GNU-GPLv2 license (http://www.gnu.org/licenses/gpl-2.0.html) and open to any user or organization, as    long as you use it under this license.

*/

import "pe"

rule MS17_010_WanaCry_worm {
	meta:
		description = "Worm exploiting MS17-010 and dropping WannaCry Ransomware"
		author = "Felipe Molina (@felmoltor)"
		reference = "https://www.exploit-db.com/exploits/41987/"
		date = "2017/05/12"
	strings:
		$ms17010_str1="PC NETWORK PROGRAM 1.0"
		$ms17010_str2="LANMAN1.0"
		$ms17010_str3="Windows for Workgroups 3.1a"
		$ms17010_str4="__TREEID__PLACEHOLDER__"
		$ms17010_str5="__USERID__PLACEHOLDER__"
		$wannacry_payload_substr1 = "h6agLCqPqVyXi2VSQ8O6Yb9ijBX54j"
		$wannacry_payload_substr2 = "h54WfF9cGigWFEx92bzmOd0UOaZlM"
		$wannacry_payload_substr3 = "tpGFEoLOU6+5I78Toh/nHs/RAP"

	condition:
		all of them
} — https://github.com/felmoltor/rules/blob/master/malware/malw_ms17-010_wannacrypt.yar
* sha256: <sha256> — Stage2 dropped by worm-only variant - https://blog.comae.io/wannacry-new-variants-detected-b8908fefea7e

### External analysis
* link: https://www.bleepingcomputer.com/news/security/telefonica-tells-employees-to-shut-down-computers-amid-massive-ransomware-outbreak/ — ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa
* link: https://www.hybrid-analysis.com/sample/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa?environmentId=100
* link: https://gist.github.com/rain-1/989428fa5504f378b993ee6efbc0b168

### Network activity
* comment: Performs connections to tor network
* domain: gx7ekbenv2riucmf.onion — C&C tor servers - https://twitter.com/hackerfantastic/status/863115568181850113
* domain: 57g7spgrzlojinas.onion — C&C tor servers - https://twitter.com/hackerfantastic/status/863115568181850113
* domain: xxlvbrloxvriy2c5.onion — C&C tor servers - https://twitter.com/hackerfantastic/status/863115568181850113
* domain: 76jdd2ir2embyv47.onion — C&C tor servers - https://twitter.com/hackerfantastic/status/863115568181850113
* domain: cwwnhwhlz52maqm7.onion — C&C tor servers - https://twitter.com/hackerfantastic/status/863115568181850113
* hostname: www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com — Killswitch domain. Direct access must be allowed
* hostname: www.ifferfsodp9ifjaposdfjhgosurijfaewrwergwea.com — Killswitch domain. Direct access must be allowed. https://twitter.com/msuiche/status/863730377642442752
* hostname: www.ayylmaotjhsstasdfasdfasdfasdfasdfasdfasdf.com — Killswitch domain. Direct access must be allowed
* hostname: www.lazarusse.suiche.sdfjhgosurijfaqwqwqrgwea.com — Killswitch domain. Direct access must be allowed
* hostname: www.iuqssfsodp9ifjaposdfjhgosurijfaewrwergwea.com — Killswitch domain. Direct access must be allowed
* hostname: www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergweb.com — Killswitch domain. Direct access must be allowed

### Payload delivery
* md5: <md5> — taskdl.exe
* md5: <md5> — taskse.exe
* sha1: <sha1> — taskdl.exe
* sha1: <sha1> — taskse.exe
* sha256: <sha256> — taskdl.exe
* sha256: <sha256> — wannacry.exe
* sha256: <sha256> — taskse.exe
* sha256: <sha256> — u.wnry
* filename: 176641494574290.bat — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: @Please_Read_Me@.txt — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: @WanaDecryptor@.exe — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: @WanaDecryptor@.exe.lnk — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: Please Read Me!.txt — (Older variant) - https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: %WINDIR%\tasksche.exe — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: %WINDIR%\qeriuwjhrf — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: 131181494299235.bat — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: 217201494590800.bat — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: [0-9]{15}.bat — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: !WannaDecryptor!.exe.lnk — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: 00000000.pky — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: 00000000.eky — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: 00000000.res — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* filename: %WINDIR%\system32\taskdl.exe — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* md5: <md5> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/
* sha256: <sha256> — ifferfsodÃ¢â‚¬Â¦ variant
* sha256: <sha256> — Worm-only variant detected by Kaspersky (encryptor is broken) - https://blog.comae.io/wannacry-new-variants-detected-b8908fefea7e
* sha256: <sha256> — diskpart.exe

### Payload installation
* yara: rule Wanna_Cry_Ransomware_Generic {
       meta:
              description = "Detects WannaCry Ransomware on disk and in virtual page"
              author = "US-CERT Code Analysis Team"
              reference = "not set"                                        
              date = "2017/05/12"
              hash0 = "4DA1F312A214C07143ABEEAFB695D904"
      
       strings:
              $s0 = {410044004D0049004E0024}
              $s1 = "WannaDecryptor"
              $s2 = "WANNACRY"
              $s3 = "Microsoft Enhanced RSA and AES Cryptographic"
              $s4 = "PKS"
              $s5 = "StartTask"
              $s6 = "wcry@123"
              $s7 = {2F6600002F72}
              $s8 = "unzip 0.15 Copyrigh"

       condition:
              $s0 and $s1 and $s2 and $s3 or $s4 or $s5 or $s6 or $s7 or $s8
} — Yara rule Wanna_Cry_Ransomware_Generic
* yara: rule MS17_010_WanaCry_worm {
       meta:
              description = "Worm exploiting MS17-010 and dropping WannaCry Ransomware"
              author = "Felipe Molina (@felmoltor)"
              reference = "https://www.exploit-db.com/exploits/41987/"
              date = "2017/05/12"

       strings:
              $ms17010_str1="PC NETWORK PROGRAM 1.0"
              $ms17010_str2="LANMAN1.0"
              $ms17010_str3="Windows for Workgroups 3.1a"
              $ms17010_str4="__TREEID__PLACEHOLDER__"
              $ms17010_str5="__USERID__PLACEHOLDER__"
              $wannacry_payload_substr1 = "h6agLCqPqVyXi2VSQ8O6Yb9ijBX54j"
              $wannacry_payload_substr2 = "h54WfF9cGigWFEx92bzmOd0UOaZlM"
              $wannacry_payload_substr3 = "tpGFEoLOU6+5I78Toh/nHs/RAP"

       condition:
              all of them
} — Yara rule MS17_010_WanaCry_worm
* yara: rule wannacry_1 : ransom
{
    meta:
        author = "Joshua Cannell"
        description = "WannaCry Ransomware strings"
        weight = 100
        date = "2017-05-12"
     
    strings:
        $s1 = "Ooops, your files have been encrypted!" wide ascii nocase
        $s2 = "Wanna Decryptor" wide ascii nocase
        $s3 = ".wcry" wide ascii nocase
        $s4 = "WANNACRY" wide ascii nocase
        $s5 = "WANACRY!" wide ascii nocase
        $s7 = "icacls . /grant Everyone:F /T /C /Q" wide ascii nocase
     
    condition:
        any of them
} — Yara rule wannacry_1 : ransom
* yara: rule wannacry_2
{
    meta:
        author = "Harold Ogden"
        description = "WannaCry Ransomware Strings"
        date = "2017-05-12"
        weight = 100

    strings:
        $string1 = "msg/m_bulgarian.wnry"
        $string2 = "msg/m_chinese (simplified).wnry"
        $string3 = "msg/m_chinese (traditional).wnry"
        $string4 = "msg/m_croatian.wnry"
        $string5 = "msg/m_czech.wnry"
        $string6 = "msg/m_danish.wnry"
        $string7 = "msg/m_dutch.wnry"
        $string8 = "msg/m_english.wnry"
        $string9 = "msg/m_filipino.wnry"
        $string10 = "msg/m_finnish.wnry"
        $string11 = "msg/m_french.wnry"
        $string12 = "msg/m_german.wnry"
        $string13 = "msg/m_greek.wnry"
        $string14 = "msg/m_indonesian.wnry"
        $string15 = "msg/m_italian.wnry"
        $string16 = "msg/m_japanese.wnry"
        $string17 = "msg/m_korean.wnry"
        $string18 = "msg/m_latvian.wnry"
        $string19 = "msg/m_norwegian.wnry"
        $string20 = "msg/m_polish.wnry"
        $string21 = "msg/m_portuguese.wnry"
        $string22 = "msg/m_romanian.wnry"
        $string23 = "msg/m_russian.wnry"
        $string24 = "msg/m_slovak.wnry"
        $string25 = "msg/m_spanish.wnry"
        $string26 = "msg/m_swedish.wnry"
        $string27 = "msg/m_turkish.wnry"
        $string28 = "msg/m_vietnamese.wnry"

    condition:
        any of ($string*)
} — Yara rule wannacry_2
* yara: rule WannaDecryptor: WannaDecryptor
{
        meta:
                description = "Detection for common strings of WannaDecryptor"

        strings:
                $id1 = "taskdl.exe"
                $id2 = "taskse.exe"
                $id3 = "r.wnry"
                $id4 = "s.wnry"
                $id5 = "t.wnry"
                $id6 = "u.wnry"
                $id7 = "msg/m_"

        condition:
                3 of them
} — Yara rule WannaDecryptor: WannaDecryptor
* yara: rule Wanna_Sample_84c82835a5d21bbcf75a61706d8ab549: Wanna_Sample_84c82835a5d21bbcf75a61706d8ab549
{
        meta:
                description = "Specific sample match for WannaCryptor"
                MD5 = "84c82835a5d21bbcf75a61706d8ab549"
                SHA1 = "5ff465afaabcbf0150d1a3ab2c2e74f3a4426467"
                SHA256 = "ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa"
                INFO = "Looks for 'taskdl' and 'taskse' at known offsets"

        strings:
                $taskdl = { 00 74 61 73 6b 64 6c }
                $taskse = { 00 74 61 73 6b 73 65 }

        condition:
                $taskdl at 3419456 and $taskse at 3422953
} — Yara rule Wanna_Sample_84c82835a5d21bbcf75a61706d8ab549: Wanna_Sample_84c82835a5d21bbcf75a61706d8ab549
* yara: rule Wanna_Sample_4da1f312a214c07143abeeafb695d904: Wanna_Sample_4da1f312a214c07143abeeafb695d904
{
        meta:
                description = "Specific sample match for WannaCryptor"
                MD5 = "4da1f312a214c07143abeeafb695d904"
                SHA1 = "b629f072c9241fd2451f1cbca2290197e72a8f5e"
                SHA256 = "aee20f9188a5c3954623583c6b0e6623ec90d5cd3fdec4e1001646e27664002c"
                INFO = "Looks for offsets of r.wry and s.wry instances"

        strings:
                $rwnry = { 72 2e 77 72 79 }
                $swnry = { 73 2e 77 72 79 }

        condition:
                $rwnry at 88195 and $swnry at 88656 and $rwnry at 4495639
} — Yara rule Wanna_Sample_4da1f312a214c07143abeeafb695d904: Wanna_Sample_4da1f312a214c07143abeeafb695d904
* yara: rule NHS_Strain_Wanna: NHS_Strain_Wanna
{
        meta:
                description = "Detection for worm-strain bundle of Wcry, DOublePulsar"
                MD5 = "db349b97c37d22f5ea1d1841e3c89eb4"
                SHA1 = "e889544aff85ffaf8b0d0da705105dee7c97fe26"
                SHA256 = "24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c"
                INFO = "Looks for specific offsets of c.wnry and t.wnry strings"

        strings:
                $cwnry = { 63 2e 77 6e 72 79 }
                $twnry = { 74 2e 77 6e 72 79 }

        condition:
                $cwnry at 262324 and $twnry at 267672 and $cwnry at 284970
} — Yara rule NHS_Strain_Wanna: NHS_Strain_Wanna

### Persistence mechanism
* regkey|value: HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\\|\tasksche.exe — https://blog.fox-it.com/2017/05/13/faq-on-the-wanacry-ransomware-outbreak/
