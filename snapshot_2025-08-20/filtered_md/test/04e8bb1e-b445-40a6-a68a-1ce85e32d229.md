# Threat Report: 2023-04-13: QUARTERRIG - Malware Analysis Report


## Key Intelligence
* Date: 2023-04-13
* Threat Level: 1 (High)
* Tags: misp-galaxy:tool="QUARTERRIG", misp-galaxy:mitre-attack-pattern="Virtual Private Server - T1583.003", misp-galaxy:mitre-attack-pattern="Compromise Infrastructure - T1584", misp-galaxy:mitre-attack-pattern="Phishing - T1566", misp-galaxy:mitre-attack-pattern="Spearphishing Attachment - T1566.001", misp-galaxy:mitre-attack-pattern="Spearphishing Link - T1566.002", misp-galaxy:mitre-attack-pattern="User Execution - T1204", misp-galaxy:mitre-attack-pattern="Malicious File - T1204.002", misp-galaxy:mitre-attack-pattern="Registry Run Keys / Startup Folder - T1547.001", misp-galaxy:mitre-attack-pattern="DLL Search Order Hijacking - T1574.001", misp-galaxy:mitre-attack-pattern="DLL Side-Loading - T1574.002", misp-galaxy:mitre-attack-pattern="HTML Smuggling - T1027.006", misp-galaxy:mitre-attack-pattern="Deobfuscate/Decode Files or Information - T1140", misp-galaxy:mitre-attack-pattern="Mark-of-the-Web Bypass - T1553.005", type:OSINT, osint:lifetime="perpetual", tlp:white, tlp:clear

---

## Indicators of Compromise (IOCs)
### External analysis
* attachment: phishing email containing a PDF with a link to ENVYSCOUT delivering QUARTERRIG.png — phishing email containing a PDF with a link to ENVYSCOUT delivering QUARTERRIG
* attachment: PDF containing a link to ENVYSCOUT.png — phishing email containing a PDF with a link to ENVYSCOUT delivering QUARTERRIG
* attachment: PDF containing a link to ENVYSCOUT2.png — PDF containing a link to ENVYSCOUT

### Network activity
* url: pateke.com/auth/login.php — QUARTERRIG C2 URL
* url: pateke.com/index.php — QUARTERRIG C2 URL
* url: gatewan.com/c/msdownload/update/others/2021/10/se9fW4z8WJtmMyPQu — COBALT STRIKE Handler URL
* url: gatewan.com/c/msdownload/update/others/2021/10/8PaDBDxLtokI3eH8 — COBALT STRIKE Handler URL
* url: sharpledge.com/login.php — QUARTERRIG C2 URL
* url: sylvio.com.br/form.php — URL to ENYVYSCOUT used to deliver QUARTERRIG
* hostname: sylvio.com.br — Domain used to host ENVYSCOUT

## Objects
### report — Metadata used to generate an executive level report
* [External analysis] link: https://www.gov.pl/attachment/6f51bb1a-3ad2-461c-a16d-408915a56f77
* [Other] text: QUARTERRIG is a dropper that was used in an espionage campaign significantly overlapping with publicly described activity linked to the APT29 and NOBELIUM activity sets. QUARTERRIG does not contain any other capabilities aside from downloading and executing 2nd stage. To bypass security products, QUARTERRIG heavily relies on obfuscation based on opaque predicates and multi-stage execution, interweaving shellcode and PE files. HALFRIG and QUARTERRIG share some of the codebase, suggesting that QUARTERRIG authors have access to both HALFRIG source code and the same obfuscation libraries.
* [Other] text: Report
* [External analysis] attachment: QUARTERRIG_.pdf

### yara — An object describing a YARA rule (or a YARA rule name) along with its version.
* [Other] comment: A rule that can be used to scan for QUARTERRIG
* [External analysis] link: https://www.gov.pl/attachment/6e085a2c-ac05-4b62-9423-5d6e9ef730bf
* [Payload installation] yara: rule apt29_QUARTERRIG {
strings:
$str_dll_name = "hijacker.dll"
$str_import_name = "VCRUNTIME140.dll"
// 48 8B 15 39 6A 00 00
mov
rdx, cs:api_stuff.OpenThread
// 48 8D 0D FA 68 00 00
lea
rcx, api_stuff
// 8B D8
mov
ebx, eax
// E8 3F 25 00 00
call
load_api_addr
// 44 8B C3
mov
r8d, ebx
// 33 D2
xor
edx, edx
// B9 FF FF 1F 00
mov
ecx, 1FFFFFh
// FF D0
call
rax
$op_resolve_and_call_openthread = { 48 [6] 48 [6] 8B D8 E8 [4] [3] 33 D2 B9 FF FF 1F 00 FF D0 }
// E8 A0 25 00 00
call
load_api_addr
// 48 8B CB
mov
rcx, rbx
// FF D0
call
rax
// 83 F8 FF
cmp
eax, 0FFFFFFFFh
$op_resolve_and_call_suspendthread = { E8 [4] 48 8B CB FF D0 83 F8 FF }
condition:
all of them
}
* [Other] text: apt29_QUARTERRIG

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: Note.iso
* [Other] size-in-bytes: 2624000

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: Note.exe
* [Other] size-in-bytes: 1600000

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: AppvIsvSubsystems64.dll
* [Other] size-in-bytes: 28000

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: bdcmetadataresource.xsd
* [Other] size-in-bytes: 456000

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: Invite.iso
* [Other] size-in-bytes: 6464000

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: Invite.exe
* [Other] size-in-bytes: 5380000

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: winhttp.dll
* [Other] size-in-bytes: 32000

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: Stamp.aapp
* [Other] size-in-bytes: 460000

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: Note.iso
* [Other] size-in-bytes: 2688000

### file — File object describing a file with meta-information
* [Payload delivery] sha1: <sha1>
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: AppvIsvSubsystems64.dll
* [Other] size-in-bytes: 26000

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5>
* [Payload delivery] sha256: <sha256>
* [Payload delivery] filename: bdcmetadataresource.xsd
* [Other] size-in-bytes: 489757
* [Payload delivery] sha1: <sha1>

### domain-ip — A domain/hostname and IP address seen as a tuple in a specific time frame.
* [Network activity] domain: sharpledge.com — QUARTERRIG C2 Domain
* [Network activity] ip-dst: 51.75.210.218 — QUARTERRIG server IP

### domain-ip — A domain/hostname and IP address seen as a tuple in a specific time frame.
* [Network activity] domain: pateke.com — QUARTERRIG Domain
* [Network activity] ip-dst: 85.195.89.91 — QUARTERRIG server IP

### domain-ip — A domain/hostname and IP address seen as a tuple in a specific time frame.
* [Network activity] domain: gatewan.com — COBALT STRIKE C2 Domain
* [Network activity] ip-dst: 91.218.183.90 — COBALT STRIKE C2 IP
