# Threat Report: 2024-02-06: MOD Netherlands uncovers COATHANGER, a stealthy Chinese FortiGate RAT


## Key Intelligence
* Date: 2024-02-06
* Threat Level: 1 (High)
* Tags: misp-galaxy:country="china", misp-galaxy:target-information="Netherlands", tlp:white, misp-galaxy:sector="Government, Administration", misp-galaxy:sector="Military", misp-galaxy:sector="Research - Innovation", misp-galaxy:mitre-attack-pattern="Vulnerabilities - T1588.006"

---

## Indicators of Compromise (IOCs)
### External analysis
* link: https://www.ncsc.nl/documenten/publicaties/2024/februari/6/mivd-aivd-advisory-coathanger-tlp-clear
* link: https://github.com/JSCU-NL/COATHANGER
* vulnerability: CVE-2022-42475

### Network activity
* ja3-fingerprint-md5: 339f6adf54e6076d069dcaac54fddc25 — # This JA3-hash is a fingerprint for connections originating # from FortiGate devices that support all encryption and # hashing algorithms for doing TLS.  # Whereas the far majority of TLS-connections use different # parameters, the built-in logging functionality of FortiGate # devices seems to make use of identical TLS-parameters, # leading to potential false positive results from this JA3 # hash.  # Therefore, traffic should be judged as legitimate (i.e., as # false positive indicator of COATHANGER) if it originates # from a FortiGate device and has: # − port 541 or 514 as destination port and # − an IP address belonging to Fortinet Inc. or a Fortinet # device, such as a FortiManager as destination.

### Other
* comment: - The Ministry of Defence (MOD) of the Netherlands was impacted in 2023 by an intrusion into one of its networks. The effects were limited because of prior network segmentation.
* comment: − Incident response uncovered previously unpublished malware, a remote access trojan (RAT) designed specifically for Fortigate appliances. It is used as second-stage malware, and does not exploit a new vulnerability. Intelligence services MIVD & AIVD refer to the malware as COATHANGER based on a string present in the code.
* comment: − The COATHANGER malware is stealthy and persistent. It hides itself by hooking system calls that could reveal its presence. It survives reboots and firmware upgrades.
* comment: − MIVD & AIVD assess with high confidence that the malicious activity was conducted by a state- sponsored actor from the People’s Republic of China. This is part of a wider trend of Chinese political espionage against the Netherlands and its allies.
* comment: − MIVD & AIVD assess that use of COATHANGER may be relatively targeted. The Chinese threat actor(s) scan for vulnerable edge devices at scale and gain access opportunistically, and likely introduce COATHANGER as a communication channel for select victims.
* comment: − Action that organizations can take to prevent future malicious activity: for all internet-facing (edge) devices, install security patches from the vendor as soon as they become available.
* comment: The COATHANGER implant is persistent, recovering after every reboot by injecting a backup of itself in the process responsible for rebooting the system. Moreover, the infection survives firmware upgrades. Even fully patched FortiGate devices may therefore be infected, if they were compromised before the latest patch was applied.
* comment: Therefore, any suspicious outgoing connections to external IP addresses from a process called httpsd is a strong indicator of the presence of COATHANGER: <device_IP>:<device_port>-><c2_IP>:<c2_port>->state=established err=0 socktype=1 rma=0 wma=0fma=0 tma=0 inode=<inode> process=<PID>/httpsd
* comment: The PIDs of process that have suspicious outgoing connections can be used as a starting point for conducting this check. When the process has a GID set to 90, the device is infected with COATHANGER.
* comment: It is not expected behavior of an isolated FortiGate device to connect to other domains than those related to Fortinet or domains/IPs listed in the configuration of the device.

### Payload installation
* yara: rule COATHANGER_files
{
    meta:
        description = "Detects COATHANGER files by used filenames"
        malware = "COATHANGER"
        author = "NLD MIVD - JSCU"
        date = "20240206"
    strings:
        $1 = "/data2/"
        $2 = "/httpsd"
        $3 = "/preload.so"
        $4 = "/authd"
        $5 = "/tmp/packfile"
        $6 = "/smartctl"
        $7 = "/etc/ld.so.preload"
        $8 = "/newcli"
        $9 = "/bin/busybox"

    condition:
        (uint32(0) == 0x464c457f or uint32(4) == 0x464c457f)
        and filesize < 5MB and 4 of them
}
* yara: rule COATHANGER_beacon
{
    meta:
        description = "Detects COATHANGER beaconing code (GET / HTTP/2\nHost: www.google.com\n\n)"
        malware = "COATHANGER"
        author = "NLD MIVD - JSCU"
        date = "20240206"
    strings:
        $chunk_1 = {
            48 B8 47 45 54 20 2F 20 48 54
            48 89 45 B0
            48 B8 54 50 2F 32 0A 48 6F 73
            48 89 45 B8
            48 B8 74 3A 20 77 77 77 2E 67
            48 89 45 C0
            48 B8 6F 6F 67 6C 65 2E 63 6F
        }

    condition:
        uint32(0) == 0x464c457f and filesize < 5MB and
        any of them
}

## Objects
### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — preload.so
* [Payload delivery] sha1: <sha1> — preload.so
* [Payload delivery] sha256: <sha256> — preload.so

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — newcli
* [Payload delivery] sha1: <sha1> — newcli
* [Payload delivery] sha256: <sha256> — newcli

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — unpack.so
* [Payload delivery] sha1: <sha1> — unpack.so
* [Payload delivery] sha256: <sha256> — unpack.so

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — httpsd
* [Payload delivery] sha1: <sha1> — httpsd
* [Payload delivery] sha256: <sha256> — httpsd

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — packfile
* [Payload delivery] sha1: <sha1> — packfile
* [Payload delivery] sha256: <sha256> — packfile

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — preload.so
* [Payload delivery] sha1: <sha1> — preload.so
* [Payload delivery] sha256: <sha256> — preload.so

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — sh
* [Payload delivery] sha1: <sha1> — sh
* [Payload delivery] sha256: <sha256> — sh

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — ld.so.preload
* [Payload delivery] sha1: <sha1> — ld.so.preload
* [Payload delivery] sha256: <sha256> — ld.so.preload

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — sh
* [Payload delivery] sha1: <sha1> — sh
* [Payload delivery] sha256: <sha256> — sh

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — preload.so
* [Payload delivery] sha1: <sha1> — preload.so
* [Payload delivery] sha256: <sha256> — preload.so

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — liblog.so / ld.so.preload
* [Payload delivery] sha1: <sha1> — liblog.so / ld.so.preload
* [Payload delivery] sha256: <sha256> — liblog.so / ld.so.preload

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — authd
* [Payload delivery] sha1: <sha1> — authd
* [Payload delivery] sha256: <sha256> — authd

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — packfile
* [Payload delivery] sha1: <sha1> — packfile
* [Payload delivery] sha256: <sha256> — packfile

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — newcli
* [Payload delivery] sha1: <sha1> — newcli
* [Payload delivery] sha256: <sha256> — newcli

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — ld.so.preload
* [Payload delivery] sha1: <sha1> — ld.so.preload
* [Payload delivery] sha256: <sha256> — ld.so.preload

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — newcli
* [Payload delivery] sha1: <sha1> — newcli
* [Payload delivery] sha256: <sha256> — newcli

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — libpe.so
* [Payload delivery] sha1: <sha1> — libpe.so
* [Payload delivery] sha256: <sha256> — libpe.so

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — smartctl
* [Payload delivery] sha1: <sha1> — smartctl
* [Payload delivery] sha256: <sha256> — smartctl

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — authd
* [Payload delivery] sha1: <sha1> — authd
* [Payload delivery] sha256: <sha256> — authd

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — httpsd
* [Payload delivery] sha1: <sha1> — httpsd
* [Payload delivery] sha256: <sha256> — httpsd

### file — File object describing a file with meta-information
* [Payload delivery] md5: <md5> — httpsd
* [Payload delivery] sha1: <sha1> — httpsd
* [Payload delivery] sha256: <sha256> — httpsd
* [Payload delivery] ssdeep: <ssdeep> — httpsd
* [Payload delivery] tlsh: <tlsh>
